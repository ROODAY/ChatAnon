<!DOCTYPE html>
<html>
  <head>
    <title>ChatAnon</title>
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="favicons/favicon-144.png">
    <meta name="msapplication-config" content="favicons/browserconfig.xml">

    <link rel="shortcut icon" href="favicons/favicon.ico">
    <link rel="icon" sizes="16x16 32x32 64x64" href="favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="196x196" href="favicons/favicon-196.png">
    <link rel="icon" type="image/png" sizes="160x160" href="favicons/favicon-160.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicons/favicon-96.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicons/favicon-64.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicons/favicon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicons/favicon-144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicons/favicon-120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicons/favicon-114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicons/favicon-76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicons/favicon-72.png">
    <link rel="apple-touch-icon" href="favicons/favicon-57.png">

    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="css/vendor/jquery.mCustomScrollbar.css">
    <link rel="stylesheet" href="css/vendor/buttons.css">
    <link rel="stylesheet" href="css/styles.css">
  </head>
  <body>
    <div id="options">
        <span id="mainbtn" class="glyphicon glyphicon-cog" data-toggle="modal" data-target="#myModal"></span>
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-body">
                Options:
                <ul style="list-style-type: none;">
                    <li>Join/Create a Room <span class="glyphicon glyphicon-plus" id="joinroombtn"></span></li>
                    <li>Back to Default Room <span class="glyphicon glyphicon-th-list" id="defroombtn"></span></li>
                    <li>
                        Current Rooms:<br>
                        <ul id="roomlist"></ul>
                    </li>
                </ul>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
    </div>
    <div id="header">
        <h1><span id="roomname"></span>:</h1>
        <h3><span id="users"></span> Users Connected</h3>
    </div>
    <div id="messageblock">
        <ul id="messages"></ul>
    </div>
    <div id="send">
        <form action="">
          <input id="m" autocomplete="off" /><button class="button button-rounded button-flat-primary">Send</button>
        </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="js/buttons.js"></script>
    <script src="js/linkify.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
    	var socket = io();
        var data = {};
        var localID = 0;
        var localColor = 0;
        var localscroll = 100;
        var missed = 0;
        var blurred = false;
        var focused = true;
        var lastmsg = Date.now();
        var nummessages = $("#messages").children().length;

        $("#joinroombtn").click(function() {
            var room = prompt("Enter the Room ID you wish to join or create.");
            socket.emit("joinRoom", room);
        });
        $("#defroombtn").click(function() {
            socket.emit("joinRoom", "ChatAnon");
        });

        function checkScroll(scroll) {
            if (scroll >= 80) {
                $("#messageblock").mCustomScrollbar("scrollTo","bottom", {
                    scrollInertia:1
                });
            } else {
                missed += 1;
            }
            if (blurred) {
                if (missed > 0) {
                    document.title = "(" + missed + ") New Messages";
                }
                var newmessagesound = new Audio("newmessage.wav");
                newmessagesound.play();
            }
            if (scroll >= 90) {
                missed = 0;
            }
        }

        socket.on("enterRoom", function(room) {
            if (room != false) {
                alert("You have entered room " + room + "!");
            } else {
                alert("Error. Please try another room.");
            }
        })

        socket.on("roomList", function(rl) {
            $("#roomlist").html("");
            rl.forEach(function(room){
                $("#roomlist").append($("<li>").text(room));
            });
        });

        socket.on("alert", function(msg) {
            alert(msg);
        });

        socket.on('firstjoin', function(oldmessages) {
            for (var i = 0; i < oldmessages.length; i++) {
                $('#messages').append($('<li style="color:' + oldmessages[i][1] + ';">').text(oldmessages[i][0]).linkify());
                if (nummessages > 50) {
                    $("#messages:first-child").remove();
                }
            }
        });
        socket.on('localID', function(id) {
            localID = id;
        });
        socket.on('senddata', function(arg){
            data = arg;
            localColor = data.users[localID];
            $("#roomname").html(arg.roomname)
            $('#users').html(arg.totalUsers);
        });

        socket.on('ding', function(arg) {
            var ding = new Audio("ding.wav");
            ding.play();
            return arg;
        });

    	$('form').submit(function(){
            var cmdtest = $("#m").val();
            if (cmdtest[0] === "/") {
                cmdtest = cmdtest.substr(1);
                $('#m').val('');
                if (cmdtest === "help") {
                    $('#messages').append($('<li style="color: \'black\';" class="rainbow">').text("The commands are: ").linkify());
                } else if (cmdtest === "setcolor") {
                    localColor = prompt("Type a valid html color. (ex. #333333, rgb(23,53,100), 'red')");
                } else {
                    $('#messages').append($('<li style="color: \'black\';" class="rainbow">').text("That is not a valid command.").linkify());
                }
                checkScroll(localscroll);
                return false;
            } else {
                if ($('#m').val().length <= 500) {
                    if (((Date.now() - lastmsg) / 1000) > 1.5) {
                        socket.emit('chat message', $('#m').val(), localColor);
                        $('#m').val('');
                        lastmsg = Date.now();
                        return false;
                    } else {
                        if ($("#m").val().length > 0) {
                            $('#messages').append($('<li style="color: \'black\';" class="rainbow">').text("You must wait 1.5 seconds between messages!").linkify());
                            checkScroll(localscroll);
                        }
                        return false;  
                    }
                } else {
                    alert( $("#m").val().length + " is too many characters! It has to be under 500!")
                    return false;
                }
            }
    	});

    	socket.on('chat message', function(msg, color){
            if (msg != "") {
                $('#messages').append($('<li style="color:' + color + ';">').text(msg).linkify());
                nummessages = $("#messages li").children().length;
                if (nummessages > 50) {
                    $("#messages:first-child").remove();
                }
                socket.emit('pushli', msg, color);
                checkScroll(localscroll);
            }
    	});

        socket.on('console chat message', function(msg){
                $('#messages').append($('<li style="color:\'black\';" class="rainbow">').text(msg).linkify());
                checkScroll(localscroll);
        });

        (function($){
            $(window).load(function(){
               $("#messageblock").mCustomScrollbar({
                    axis:"y",
                    theme:"dark",
                    callbacks:{
                        whileScrolling:function(){ 
                            localscroll = this.mcs.topPct;
                        }
                    },
                });
            });
        })(jQuery);
    </script>
    <script>
    $(document).ready(function(){
         $("#m").keypress(function(){
            if ($("#m").val().length > 500) {
                $("button").removeClass("button-flat-primary");
                $("button").removeClass("button-flat-caution");
                $("button").addClass("button-flat-caution");
            } else {
                $("button").removeClass("button-flat-primary");
                $("button").removeClass("button-flat-caution");
                $("button").addClass("button-flat-primary");
            }
        });
    });
    $(window).on("blur focus", function(e) {
        var prevType = $(this).data("prevType");

        if (prevType != e.type) {   //  reduce double fire issues
            switch (e.type) {
                case "blur":
                    blurred = true;
                    focused = false;
                    if (missed > 0 ) {
                        document.title = "(" + missed + ") New Messages";
                    }
                    break;
                case "focus":
                    focused = true;
                    blurred = false;
                    document.title = "Super Secret Chat";
                    break;
            }
        }

        $(this).data("prevType", e.type);
    })
    </script>
  </body>
</html>